{
  "version": 3,
  "sources": ["../../src/main.js"],
  "sourcesContent": ["import * as core from '@actions/core';\nimport * as github from '@actions/github';\nimport * as artifact from '@actions/artifact';\nimport * as exec from '@actions/exec';\nimport * as glob from '@actions/glob';\nimport * as path from 'path';\nimport lcovTotal from 'lcov-total';\nimport fs from 'fs';\nimport { config, inputs } from './config';\n\nfunction sha() {\n  const full = github.context.payload.pull_request.head.sha;\n  return {\n    full,\n    short: full.substr(0, 7),\n  };\n}\n\nfunction buildHeader(isMinimumCoverageReached) {\n  return `## ${isMinimumCoverageReached ? '' : ':no_entry:'} Code coverage of commit [<code>${sha().short}</code>](${\n    github.context.payload.pull_request.number\n  }/commits/${sha().full})\\n\\n`;\n}\n\nfunction buildMessageBody(params) {\n  const { header, summary, details, isMinimumCoverageReached, errorMessage } = params;\n\n  return `${header}<pre>${summary}\\n\\nChanged files coverage rate: ${details}</pre>\\n\\n${\n    isMinimumCoverageReached ? '' : `:no_entry: ${errorMessage}`\n  }`;\n}\n\nfunction runningInPullRequest() {\n  const allowedGitHubEvents = ['pull_request', 'pull_request_target'];\n  return allowedGitHubEvents.includes(github.context.eventName);\n}\n\nasync function getExistingPRComment(octokitInstance) {\n  const issueComments = await octokitInstance.rest.issues.listComments({\n    repo: github.context.repo.repo,\n    owner: github.context.repo.owner,\n    issue_number: github.context.payload.pull_request.number,\n  });\n\n  return issueComments.data.find((comment) => comment.body.includes('Code coverage'));\n}\n\nasync function commentOnPR(params) {\n  const { updateComment, body, octokit } = params;\n\n  const existingComment = await getExistingPRComment(octokit);\n  const shouldUpdateComment = updateComment && existingComment;\n  const prAction = shouldUpdateComment ? octokit.rest.issues.updateComment : octokit.rest.issues.createComment;\n  const data = {\n    repo: github.context.repo.repo,\n    owner: github.context.repo.owner,\n    body,\n    ...(shouldUpdateComment\n      ? { comment_id: existingComment.id }\n      : { issue_number: github.context.payload.pull_request.number }),\n  };\n\n  prAction(data);\n}\n\nfunction roundToOneDecimalPlace(num) {\n  return Math.round(num * 10) / 10;\n}\n\nasync function listFiles(path) {\n  const globber = await glob.create(path, { followSymbolicLinks: false, matchDirectories: false });\n  return await globber.glob();\n}\n\nfunction createTempDir() {\n  try {\n    const tmpPath = `${process.env.GITHUB_WORKSPACE}/lcov-tmp-dir`;\n    fs.mkdirSync(tmpPath);\n    return tmpPath;\n  } catch (error) {\n    core.error(`${config.action_msg_prefix} creating a temp dir failed with: ${error.message}`);\n    process.exit(1);\n  }\n}\n\nasync function run() {\n  const tmpDir = createTempDir();\n  const coverageFiles = await listFiles(inputs.coverageFilesPattern);\n  if (!coverageFiles.length) {\n    core.error(`${config.action_msg_prefix} no coverage lcov files found with pattern ${inputs.coverageFilesPattern}`);\n    process.exit(1);\n  }\n\n  try {\n    const mergedCoverageFile = await mergeCoverages(coverageFiles, tmpDir);\n    const totalCoverageRounded = roundToOneDecimalPlace(lcovTotal(mergedCoverageFile));\n    const errorMessage = `Code coverage: **${totalCoverageRounded}** %. Expected at least **${inputs.minimumCoverage}** %.`;\n    const isMinimumCoverageReached = totalCoverageRounded >= inputs.minimumCoverage;\n\n    if (inputs.gitHubToken && runningInPullRequest()) {\n      const octokit = github.getOctokit(inputs.gitHubToken);\n      const body = buildMessageBody({\n        header: buildHeader(isMinimumCoverageReached),\n        summary: await summarize(mergedCoverageFile),\n        details: await detail(mergedCoverageFile, octokit),\n        isMinimumCoverageReached,\n        errorMessage,\n      });\n\n      commentOnPR({\n        octokit,\n        updateComment: inputs.updateComment,\n        body,\n      });\n    } else {\n      core.warning(\n        `${config.action_msg_prefix} no github-token provided or not running in a PR workflow. Skipping creating a PR comment.`,\n      );\n    }\n\n    if (inputs.artifactName) {\n      generateHTMLAndUpload(coverageFiles, inputs.artifactName, tmpDir);\n    }\n\n    core.setOutput('total-coverage', totalCoverageRounded);\n    if (!isMinimumCoverageReached) {\n      core.setFailed(errorMessage.replace(/\\*/g, ''));\n    }\n  } catch (error) {\n    core.setFailed(`${config.action_msg_prefix} ${error.message}`);\n  }\n}\n\nasync function generateHTMLAndUpload(coverageFiles, artifactName, tmpPath) {\n  const artifactPath = path.resolve(tmpPath, 'html').trim();\n\n  const args = [...coverageFiles, ...config.common_lcov_args, '--output-directory', artifactPath];\n  await exec.exec('genhtml', args, { cwd: inputs.workingDirectory });\n\n  const htmlFiles = await listFiles(`${artifactPath}/**`);\n  artifact.create().uploadArtifact(artifactName, htmlFiles, artifactPath, { continueOnError: false });\n}\n\nasync function mergeCoverages(coverageFiles, tmpPath) {\n  const mergedCoverageFile = `${tmpPath}/merged-lcov.info`;\n  const args = [];\n\n  for (const coverageFile of coverageFiles) {\n    args.push('--add-tracefile');\n    args.push(coverageFile);\n  }\n\n  args.push('--output-file');\n  args.push(mergedCoverageFile);\n\n  await exec.exec('lcov', [...args, ...config.common_lcov_args]);\n\n  return mergedCoverageFile;\n}\n\nasync function summarize(mergedCoverageFile) {\n  let output = '';\n  const options = {\n    listeners: {\n      stdout: (data) => {\n        output += data.toString();\n      },\n      stderr: (data) => {\n        output += data.toString();\n      },\n    },\n  };\n\n  await exec.exec('lcov', ['--summary', mergedCoverageFile, ...config.common_lcov_args], options);\n\n  const lines = output.trim().split(config.newline);\n  lines.shift(); // remove debug info\n  return lines.join('\\n');\n}\n\nasync function getChangedFilenames(octokitInstance) {\n  const listFilesOptions = octokitInstance.rest.pulls.listFiles.endpoint.merge({\n    owner: github.context.repo.owner,\n    repo: github.context.repo.repo,\n    pull_number: github.context.payload.pull_request.number,\n  });\n  const listFilesResponse = await octokitInstance.paginate(listFilesOptions);\n  return listFilesResponse.map((file) => file.filename);\n}\n\nfunction lineRefersToChangedFile(lineWithFilename, changedFiles) {\n  return changedFiles.some((changedFile) => lineWithFilename.startsWith(changedFile));\n}\n\nasync function detail(coverageFile, octokit) {\n  let output = '';\n  const options = {\n    listeners: {\n      stdout: (data) => {\n        output += data.toString();\n      },\n      stderr: (data) => {\n        output += data.toString();\n      },\n    },\n  };\n\n  const args = inputs.listFullPaths ? ['--list-full-path'] : [];\n  await exec.exec('lcov', ['--list', coverageFile, ...args, ...config.common_lcov_args], options);\n\n  let lines = output.trim().split(config.newline);\n  // remove debug info\n  lines.shift();\n  lines.pop();\n  lines.pop();\n\n  const changedFiles = await getChangedFilenames(octokit);\n  lines = lines.filter((line, index) => {\n    const includeHeader = index <= 2;\n    if (includeHeader) {\n      return true;\n    }\n\n    return lineRefersToChangedFile(line, changedFiles);\n  });\n\n  const onlyHeaderRemains = lines.length === 3;\n  return onlyHeaderRemains ? 'n/a' : `\\n  ${lines.join('\\n  ')}`;\n}\n\nrun();\n"],
  "mappings": "AAAA,UAAYA,MAAU,gBACtB,UAAYC,MAAY,kBACxB,UAAYC,MAAc,oBAC1B,UAAYC,MAAU,gBACtB,UAAYC,MAAU,gBACtB,UAAYC,MAAU,OACtB,OAAOC,MAAe,aACtB,OAAOC,MAAQ,KACf,OAAS,UAAAC,EAAQ,UAAAC,MAAc,WAE/B,SAASC,GAAM,CACb,MAAMC,EAAOV,EAAO,QAAQ,QAAQ,aAAa,KAAK,IACtD,MAAO,CACL,KAAAU,EACA,MAAOA,EAAK,OAAO,EAAG,CAAC,CACzB,CACF,CAEA,SAASC,EAAYC,EAA0B,CAC7C,MAAO,MAAMA,EAA2B,GAAK,YAAY,mCAAmCH,EAAI,EAAE,KAAK,YACrGT,EAAO,QAAQ,QAAQ,aAAa,MACtC,YAAYS,EAAI,EAAE,IAAI;AAAA;AAAA,CACxB,CAEA,SAASI,EAAiBC,EAAQ,CAChC,KAAM,CAAE,OAAAC,EAAQ,QAAAC,EAAS,QAAAC,EAAS,yBAAAL,EAA0B,aAAAM,CAAa,EAAIJ,EAE7E,MAAO,GAAGC,CAAM,QAAQC,CAAO;AAAA;AAAA,+BAAoCC,CAAO;AAAA;AAAA,EACxEL,EAA2B,GAAK,cAAcM,CAAY,EAC5D,EACF,CAEA,SAASC,GAAuB,CAE9B,MAD4B,CAAC,eAAgB,qBAAqB,EACvC,SAASnB,EAAO,QAAQ,SAAS,CAC9D,CAEA,eAAeoB,EAAqBC,EAAiB,CAOnD,OANsB,MAAMA,EAAgB,KAAK,OAAO,aAAa,CACnE,KAAMrB,EAAO,QAAQ,KAAK,KAC1B,MAAOA,EAAO,QAAQ,KAAK,MAC3B,aAAcA,EAAO,QAAQ,QAAQ,aAAa,MACpD,CAAC,GAEoB,KAAK,KAAMsB,GAAYA,EAAQ,KAAK,SAAS,eAAe,CAAC,CACpF,CAEA,eAAeC,EAAYT,EAAQ,CACjC,KAAM,CAAE,cAAAU,EAAe,KAAAC,EAAM,QAAAC,CAAQ,EAAIZ,EAEnCa,EAAkB,MAAMP,EAAqBM,CAAO,EACpDE,EAAsBJ,GAAiBG,EACvCE,EAAWD,EAAsBF,EAAQ,KAAK,OAAO,cAAgBA,EAAQ,KAAK,OAAO,cACzFI,EAAO,CACX,KAAM9B,EAAO,QAAQ,KAAK,KAC1B,MAAOA,EAAO,QAAQ,KAAK,MAC3B,KAAAyB,EACA,GAAIG,EACA,CAAE,WAAYD,EAAgB,EAAG,EACjC,CAAE,aAAc3B,EAAO,QAAQ,QAAQ,aAAa,MAAO,CACjE,EAEA6B,EAASC,CAAI,CACf,CAEA,SAASC,EAAuBC,EAAK,CACnC,OAAO,KAAK,MAAMA,EAAM,EAAE,EAAI,EAChC,CAEA,eAAeC,EAAU7B,EAAM,CAE7B,OAAO,MADS,MAAMD,EAAK,OAAOC,EAAM,CAAE,oBAAqB,GAAO,iBAAkB,EAAM,CAAC,GAC1E,KAAK,CAC5B,CAEA,SAAS8B,GAAgB,CACvB,GAAI,CACF,MAAMC,EAAU,GAAG,QAAQ,IAAI,gBAAgB,gBAC/C,OAAA7B,EAAG,UAAU6B,CAAO,EACbA,CACT,OAASC,EAAO,CACdrC,EAAK,MAAM,GAAGQ,EAAO,iBAAiB,qCAAqC6B,EAAM,OAAO,EAAE,EAC1F,QAAQ,KAAK,CAAC,CAChB,CACF,CAEA,eAAeC,GAAM,CACnB,MAAMC,EAASJ,EAAc,EACvBK,EAAgB,MAAMN,EAAUzB,EAAO,oBAAoB,EAC5D+B,EAAc,SACjBxC,EAAK,MAAM,GAAGQ,EAAO,iBAAiB,8CAA8CC,EAAO,oBAAoB,EAAE,EACjH,QAAQ,KAAK,CAAC,GAGhB,GAAI,CACF,MAAMgC,EAAqB,MAAMC,EAAeF,EAAeD,CAAM,EAC/DI,EAAuBX,EAAuB1B,EAAUmC,CAAkB,CAAC,EAC3EtB,EAAe,oBAAoBwB,CAAoB,6BAA6BlC,EAAO,eAAe,QAC1GI,EAA2B8B,GAAwBlC,EAAO,gBAEhE,GAAIA,EAAO,aAAeW,EAAqB,EAAG,CAChD,MAAMO,EAAU1B,EAAO,WAAWQ,EAAO,WAAW,EAC9CiB,EAAOZ,EAAiB,CAC5B,OAAQF,EAAYC,CAAwB,EAC5C,QAAS,MAAM+B,EAAUH,CAAkB,EAC3C,QAAS,MAAMI,EAAOJ,EAAoBd,CAAO,EACjD,yBAAAd,EACA,aAAAM,CACF,CAAC,EAEDK,EAAY,CACV,QAAAG,EACA,cAAelB,EAAO,cACtB,KAAAiB,CACF,CAAC,CACH,MACE1B,EAAK,QACH,GAAGQ,EAAO,iBAAiB,4FAC7B,EAGEC,EAAO,cACTqC,EAAsBN,EAAe/B,EAAO,aAAc8B,CAAM,EAGlEvC,EAAK,UAAU,iBAAkB2C,CAAoB,EAChD9B,GACHb,EAAK,UAAUmB,EAAa,QAAQ,MAAO,EAAE,CAAC,CAElD,OAASkB,EAAO,CACdrC,EAAK,UAAU,GAAGQ,EAAO,iBAAiB,IAAI6B,EAAM,OAAO,EAAE,CAC/D,CACF,CAEA,eAAeS,EAAsBN,EAAeO,EAAcX,EAAS,CACzE,MAAMY,EAAe3C,EAAK,QAAQ+B,EAAS,MAAM,EAAE,KAAK,EAElDa,EAAO,CAAC,GAAGT,EAAe,GAAGhC,EAAO,iBAAkB,qBAAsBwC,CAAY,EAC9F,MAAM7C,EAAK,KAAK,UAAW8C,EAAM,CAAE,IAAKxC,EAAO,gBAAiB,CAAC,EAEjE,MAAMyC,EAAY,MAAMhB,EAAU,GAAGc,CAAY,KAAK,EACtD9C,EAAS,OAAO,EAAE,eAAe6C,EAAcG,EAAWF,EAAc,CAAE,gBAAiB,EAAM,CAAC,CACpG,CAEA,eAAeN,EAAeF,EAAeJ,EAAS,CACpD,MAAMK,EAAqB,GAAGL,CAAO,oBAC/Ba,EAAO,CAAC,EAEd,UAAWE,KAAgBX,EACzBS,EAAK,KAAK,iBAAiB,EAC3BA,EAAK,KAAKE,CAAY,EAGxB,OAAAF,EAAK,KAAK,eAAe,EACzBA,EAAK,KAAKR,CAAkB,EAE5B,MAAMtC,EAAK,KAAK,OAAQ,CAAC,GAAG8C,EAAM,GAAGzC,EAAO,gBAAgB,CAAC,EAEtDiC,CACT,CAEA,eAAeG,EAAUH,EAAoB,CAC3C,IAAIW,EAAS,GACb,MAAMC,EAAU,CACd,UAAW,CACT,OAAStB,GAAS,CAChBqB,GAAUrB,EAAK,SAAS,CAC1B,EACA,OAASA,GAAS,CAChBqB,GAAUrB,EAAK,SAAS,CAC1B,CACF,CACF,EAEA,MAAM5B,EAAK,KAAK,OAAQ,CAAC,YAAasC,EAAoB,GAAGjC,EAAO,gBAAgB,EAAG6C,CAAO,EAE9F,MAAMC,EAAQF,EAAO,KAAK,EAAE,MAAM5C,EAAO,OAAO,EAChD,OAAA8C,EAAM,MAAM,EACLA,EAAM,KAAK;AAAA,CAAI,CACxB,CAEA,eAAeC,EAAoBjC,EAAiB,CAClD,MAAMkC,EAAmBlC,EAAgB,KAAK,MAAM,UAAU,SAAS,MAAM,CAC3E,MAAOrB,EAAO,QAAQ,KAAK,MAC3B,KAAMA,EAAO,QAAQ,KAAK,KAC1B,YAAaA,EAAO,QAAQ,QAAQ,aAAa,MACnD,CAAC,EAED,OAD0B,MAAMqB,EAAgB,SAASkC,CAAgB,GAChD,IAAKC,GAASA,EAAK,QAAQ,CACtD,CAEA,SAASC,EAAwBC,EAAkBC,EAAc,CAC/D,OAAOA,EAAa,KAAMC,GAAgBF,EAAiB,WAAWE,CAAW,CAAC,CACpF,CAEA,eAAehB,EAAOM,EAAcxB,EAAS,CAC3C,IAAIyB,EAAS,GACb,MAAMC,EAAU,CACd,UAAW,CACT,OAAStB,GAAS,CAChBqB,GAAUrB,EAAK,SAAS,CAC1B,EACA,OAASA,GAAS,CAChBqB,GAAUrB,EAAK,SAAS,CAC1B,CACF,CACF,EAEMkB,EAAOxC,EAAO,cAAgB,CAAC,kBAAkB,EAAI,CAAC,EAC5D,MAAMN,EAAK,KAAK,OAAQ,CAAC,SAAUgD,EAAc,GAAGF,EAAM,GAAGzC,EAAO,gBAAgB,EAAG6C,CAAO,EAE9F,IAAIC,EAAQF,EAAO,KAAK,EAAE,MAAM5C,EAAO,OAAO,EAE9C8C,EAAM,MAAM,EACZA,EAAM,IAAI,EACVA,EAAM,IAAI,EAEV,MAAMM,EAAe,MAAML,EAAoB5B,CAAO,EACtD,OAAA2B,EAAQA,EAAM,OAAO,CAACQ,EAAMC,IACJA,GAAS,EAEtB,GAGFL,EAAwBI,EAAMF,CAAY,CAClD,EAEyBN,EAAM,SAAW,EAChB,MAAQ;AAAA,IAAOA,EAAM,KAAK;AAAA,GAAM,CAAC,EAC9D,CAEAhB,EAAI",
  "names": ["core", "github", "artifact", "exec", "glob", "path", "lcovTotal", "fs", "config", "inputs", "sha", "full", "buildHeader", "isMinimumCoverageReached", "buildMessageBody", "params", "header", "summary", "details", "errorMessage", "runningInPullRequest", "getExistingPRComment", "octokitInstance", "comment", "commentOnPR", "updateComment", "body", "octokit", "existingComment", "shouldUpdateComment", "prAction", "data", "roundToOneDecimalPlace", "num", "listFiles", "createTempDir", "tmpPath", "error", "run", "tmpDir", "coverageFiles", "mergedCoverageFile", "mergeCoverages", "totalCoverageRounded", "summarize", "detail", "generateHTMLAndUpload", "artifactName", "artifactPath", "args", "htmlFiles", "coverageFile", "output", "options", "lines", "getChangedFilenames", "listFilesOptions", "file", "lineRefersToChangedFile", "lineWithFilename", "changedFiles", "changedFile", "line", "index"]
}
